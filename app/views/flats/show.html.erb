<div class="container my-5">
  <%= link_to "‚Üê Retour aux logements", flats_path, class: "btn btn-outline-secondary mb-4" %>

  <h1 class="mb-4 text-center fw-bold"><%= @flat.name %></h1>

  <div class="text-center mb-4">
    <img src="<%= @flat.photo_url %>" alt="<%= @flat.name %>" class="img-fluid rounded shadow" style="max-height: 400px; object-fit: cover;">
  </div>

  <div class="mb-4">
    <p><strong>üìç Adresse :</strong> <%= @flat.address %></p>
    <p><strong>üí∞ Prix :</strong> <%= @flat.price_per_night %> ‚Ç¨ par nuit</p>
    <p><strong>‚≠ê Note :</strong> <%= @flat.rating %></p>
    <p><strong>üìù Description :</strong><br><%= @flat.description %></p>
  </div>

  <!-- Mapbox -->
  <div class="mb-4">
    <h3 class="mb-3">üó∫Ô∏è Localisation</h3>
    <div id="map" style="height: 400px; width: 100%;" class="rounded shadow"></div>
  </div>

  <hr class="my-4">

  <h3 class="mb-3">üõèÔ∏è R√©server cette cabane</h3>

  <% if @booking.errors.any? %>
    <div class="alert alert-danger">
      <h5>Erreurs :</h5>
      <ul>
        <% @booking.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div id="booking-dates" data-unavailable-dates="<%= @unavailable_dates.map(&:to_s).to_json %>"></div>

  <!-- Booking Form -->
  <%= form_with model: [@flat, Booking.new], data: { turbo: true } do |f| %>
    <div class="row g-3">
      <div class="col-md-6">
        <%= f.label :start_date, "üìÖ Date d'arriv√©e" %>
        <%= f.date_field :start_date, class: "form-control", min: Date.today %>
      </div>
      <div class="col-md-6">
        <%= f.label :end_date, "üìÖ Date de d√©part" %>
        <%= f.date_field :end_date, class: "form-control", min: Date.today %>
      </div>
    </div>
    <div class="mt-4 text-center">
      <%= f.submit "R√©server", class: "btn btn-primary px-5 py-2" %>
    </div>
  <% end %>
</div>


<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    mapboxgl.accessToken = '<%= ENV['MAPBOX_ACCESS_TOKEN'] %>';


    console.log('Mapbox token:', mapboxgl.accessToken ? 'Token loaded' : 'No token found');

    if (!mapboxgl.accessToken || mapboxgl.accessToken === '') {
      document.getElementById('map').innerHTML = '<div class="alert alert-danger text-center">Token Mapbox manquant. V√©rifiez votre configuration.</div>';
      return;
    }

    const latitude = <%= @flat.latitude || 'null' %>;
    const longitude = <%= @flat.longitude || 'null' %>;
    const address = '<%= j(@flat.address) %>';

    console.log('Flat coordinates:', { latitude, longitude });
    console.log('Address:', address);

    if (latitude && longitude) {
      console.log('Using stored coordinates');
      initializeMap(longitude, latitude);
    } else if (address) {
      console.log('Geocoding address:', address);
      document.getElementById('map').innerHTML = '<div class="text-center p-4">üó∫Ô∏è Localisation en cours...</div>';

      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&limit=1`)
        .then(response => response.json())
        .then(data => {
          console.log('Geocoding response:', data);

          if (data.features && data.features.length > 0) {
            const [lng, lat] = data.features[0].center;
            console.log('Geocoded coordinates:', { lat, lng });
            initializeMap(lng, lat);
          } else {
            document.getElementById('map').innerHTML = '<div class="alert alert-warning text-center">Impossible de localiser cette adresse: ' + address + '</div>';
          }
        })
        .catch(error => {
          console.error('Geocoding error:', error);
          document.getElementById('map').innerHTML = '<div class="alert alert-danger text-center">Erreur lors de la g√©olocalisation</div>';
        });
    } else {
      document.getElementById('map').innerHTML = '<div class="alert alert-warning text-center">Aucune adresse disponible</div>';
    }

    function initializeMap(lng, lat) {
      try {
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [lng, lat],
          zoom: 15
        });

        const marker = new mapboxgl.Marker({
          color: '#dc3545'
        })
        .setLngLat([lng, lat])
        .setPopup(
          new mapboxgl.Popup({ offset: 25 })
            .setHTML(`
              <div class="text-center">
                <h6><%= j(@flat.name) %></h6>
                <p class="mb-1"><small><%= j(@flat.address) %></small></p>
                <p class="mb-0"><strong><%= @flat.price_per_night %>‚Ç¨/nuit</strong></p>
              </div>
            `)
        )
        .addTo(map);

        map.addControl(new mapboxgl.NavigationControl());

        map.addControl(new mapboxgl.FullscreenControl());

        console.log('Map initialized successfully');

      } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = '<div class="alert alert-danger text-center">Erreur lors de l\'initialisation de la carte</div>';
      }
    }
  });
</script>
